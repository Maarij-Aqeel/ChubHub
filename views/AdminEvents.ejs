<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin - Pending Events</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    />
    <link rel="stylesheet" href="/css/events.css" />
  </head>
    <body>
    <!-- ===== Navbar ===== -->
   <%- include('partial/admin_nav') %>
    <!-- ===== Container ===== -->
    <div class="container">
      <div class="page-header">
        <div class="page-title">
          <i class="fas fa-calendar-check"></i>
          <h1><%= currentStatus.charAt(0).toUpperCase() + currentStatus.slice(1) %> Events</h1>
        </div>
        <% if (events && events.length > 0) { %>
        <div class="pending-count">
          <%= events.length %> Event<%= events.length !== 1 ? 's'
          : '' %> in <%= currentStatus %> status
        </div>
        <% } %>
      </div>

      <% if (events && events.length > 0) { %>
      <div class="events-grid">
        <% events.forEach(event => { %>
        <div
          class="event-card clickable"
          data-event='<%- JSON.stringify(event).replace(/'/g, "&apos;") %>'

        >
          <div class="event-top">
            <div>
              <h2><i class="fas fa-calendar-star"></i> <%= event.title %></h2>
              <div class="club-info">
                <i class="fas fa-users"></i> <%= event.club?.username ||
                'Unknown Club' %>
              </div>
            </div>
            <div class="event-status">
              <% if (event.status === 'pending') { %>
                <i class="fas fa-hourglass-half"></i> Pending
              <% } else if (event.status === 'approved') { %>
                <i class="fas fa-check-circle"></i> Approved
              <% } else if (event.status === 'rejected') { %>
                <i class="fas fa-times-circle"></i> Rejected
              <% } %>
            </div>
          </div>

          <div class="event-summary">
            <% if (event.location) { %>
            <div>
              <i class="fas fa-map-marker-alt"></i> <%= event.location %>
            </div>
            <% } %> <% if (event.startsAt) { %>
            <div>
              <i class="fas fa-calendar-day"></i> <%= new
              Date(event.startsAt).toLocaleDateString() %>
            </div>
            <% } %> <% if (event.endsAt) { %>
            <div>
              <i class="fas fa-calendar-times"></i> <%= new
              Date(event.endsAt).toLocaleDateString() %>
            </div>
            <% } %>
          </div>
        </div>
        <% }) %>
      </div>
      <% } else { %>
      <div class="empty-state">
        <i class="fas fa-check-double"></i>
        <h2>
          <% if (currentStatus === 'pending') { %>
            All Caught Up!
          <% } else if (currentStatus === 'approved') { %>
            No Approved Events
          <% } else if (currentStatus === 'rejected') { %>
            No Rejected Events
          <% } %>
        </h2>
        <p>
          <% if (currentStatus === 'pending') { %>
            No pending events to review at this time.
          <% } else if (currentStatus === 'approved') { %>
            There are no approved events in the system.
          <% } else if (currentStatus === 'rejected') { %>
            There are no rejected events in the system.
          <% } %>
        </p>
        <a href="/admin/dashboard" class="btn-back">
          <i class="fas fa-arrow-left"></i> Back to Dashboard
        </a>
      </div>
      <% } %>
    </div>

    <!-- ===== Event Modal ===== -->
    <div id="eventModal" class="modal hidden">
      <div class="modal-content">
        <span class="modal-close"><i class="fas fa-times"></i></span>
        <div class="modal-header">
          <h2 id="modalTitle"></h2>
          <div class="modal-club"></div>
        </div>
        <div class="modal-body">
          <div class="modal-details" id="modalDetails">

          </div>
        </div>
        <div class="modal-actions" id="modalActions">
          <!-- Actions will be populated by JavaScript -->
        </div>
      </div>
    </div>

    <script>
     const modal = document.getElementById("eventModal");
const modalClose = document.querySelector(".modal-close");

modalClose.addEventListener("click", () => modal.classList.add("hidden"));
modal.addEventListener("click", (e) => {
  if (e.target === modal) modal.classList.add("hidden");
});

document.querySelectorAll(".event-card.clickable").forEach(card => {
  card.addEventListener("click", () => {
    const event = JSON.parse(card.dataset.event);
    

    // ----- header -----
    document.getElementById("modalTitle").textContent = event.title;
    document.querySelector(".modal-club").textContent =
      event.club?.username || "Unknown Club";
 // ----- helper -----
    const cleanList = (str) =>
      (str || '')
        .split('\n')
        .map(l => l.replace(/^-\s*/, '').trim())
        .filter(Boolean)
        .join(', ') || null;

    // ----- details -----
    const modalDetails = document.getElementById("modalDetails");
    modalDetails.innerHTML = "";

    // Helper functions
    const formatArray = (arr) => arr && arr.length > 0 ? arr.join(', ') : null;
    const formatMembers = (members) => {
      if (!members || members.length === 0) return null;
      return members.map(m => `${m.name} (${m.id})`).join(', ');
    };
    const hasFile = (file) => file ? 'Yes' : null;
    const formatDescription = (desc) => {
      if (!desc) return null;
      // Replace **text** with <strong>text</strong> and handle line breaks
      return desc
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1:</strong>')
        .replace(/\n/g, '<br>')
        .replace(/- /g, 'â€¢ ');
    };

    const fields = [
      { label: "Description", icon: "fa-file-alt", value: formatDescription(event.description), isHTML: true },
      { label: "Location", icon: "fa-map-marker-alt", value: event.location },
      { label: "Starts At", icon: "fa-calendar-day", value: event.startsAt ? new Date(event.startsAt).toLocaleString() : null },
      { label: "Ends At", icon: "fa-calendar-times", value: event.endsAt ? new Date(event.endsAt).toLocaleString() : null },
      { label: "Capacity", icon: "fa-users", value: event.capacity },
      { label: "Activity Type", icon: "fa-tags", value: event.activityType },
      { label: "Target Audience", icon: "fa-users", value: event.targetAudience },
      { label: "Expected Attendees", icon: "fa-user-friends", value: event.expectedAttendees },
      { label: "Has Speaker", icon: "fa-microphone", value: event.hasSpeaker ? "Yes" : "No" },
      { label: "Speaker Type", icon: "fa-user-tie", value: event.speakerType },
      { label: "Speaker Name & Position", icon: "fa-user", value: event.speakerNamePosition },
      { label: "Speaker CV", icon: "fa-file-pdf", value: hasFile(event.speakerCVFile) },
      { label: "Office/Center Name", icon: "fa-building", value: event.officeCenterName },
      { label: "Representative Name", icon: "fa-handshake", value: event.representativeNameOffice },
      { label: "Role Type", icon: "fa-briefcase", value: event.roleType },
      { label: "Required Tasks", icon: "fa-tasks", value: formatArray(event.requiredTasks) },
      { label: "Responsible Members", icon: "fa-users-cog", value: formatMembers(event.responsibleMembers) },
      { label: "Reservation Confirmation", icon: "fa-file-contract", value: hasFile(event.reservationConfirmationFile) },
      { label: "Budget Files", icon: "fa-file-invoice-dollar", value: event.eventProposalBudgetFiles && event.eventProposalBudgetFiles.length > 0 ? `${event.eventProposalBudgetFiles.length} file(s)` : null }
    ];

    fields.forEach(f => {
      if (f.value !== null && f.value !== undefined && f.value !== '') {
        const p = document.createElement("p");
        if (f.isHTML) {
          p.innerHTML = `<i class="fas ${f.icon}"></i> <strong>${f.label}:</strong><br>${f.value}`;
        } else {
          p.innerHTML = `<i class="fas ${f.icon}"></i> <strong>${f.label}:</strong> ${f.value}`;
        }
        modalDetails.appendChild(p);
      }
    });

    // ----- actions -----
    const modalActions = document.getElementById("modalActions");
    modalActions.innerHTML = "";

    if (event.status === 'pending') {
      modalActions.innerHTML = `
        <form id="approveForm" method="POST" action="/admin/events/${event.id}/approve">
          <button class="btn btn-approve">
            <i class="fas fa-check-circle"></i> Approve
          </button>
        </form>
        <form id="rejectForm" method="POST" action="/admin/events/${event.id}/reject" class="reject-form">
          <textarea name="adminNotes" placeholder="Reason for rejection (optional)"></textarea>
          <button class="btn btn-reject">
            <i class="fas fa-times-circle"></i> Reject
          </button>
        </form>
      `;
    }

    modal.classList.remove("hidden");
  });
});
    </script>
  </body>
</html>
