<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Student Profile - UChub</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    /* ===== Reset & Base ===== */
    * { 
      margin: 0; 
      padding: 0; 
      box-sizing: border-box; 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    body {
      background: linear-gradient(135deg, #F3F4F6 0%, #E5E7EB 100%);
      color: #111827;
      min-height: 100vh;
    }

    /* ===== Navbar ===== */
    .navbar {
      width: 100%;
      background: linear-gradient(135deg, #1E3A8A 0%, #1E40AF 100%);
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 3rem;
      padding: 1rem 2rem;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 4px 20px rgba(30, 58, 138, 0.3);
      margin-bottom: 2rem;
    }
    
    .navbar a {
      color: #FFFFFF;
      text-decoration: none;
      font-weight: 600;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 5px;
      font-size: 0.9rem;
      transition: all 0.3s ease;
      padding: 0.5rem 1.5rem;
      border-radius: 8px;
      position: relative;
      overflow: hidden;
    }
    
    .navbar a::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.1);
      transition: left 0.3s ease;
    }
    
    .navbar a:hover::before {
      left: 0;
    }
    
    .navbar a:hover { 
      transform: translateY(-2px);
    }
    
    .navbar i { 
      font-size: 1.5rem;
    }

    /* ===== Profile Container ===== */
    .profile-container {
      max-width: 1000px;
      margin: 0 auto 3rem;
      padding: 0 1.5rem;
    }

    /* ===== Banner Section ===== */
    .banner {
      height: 220px;
      background: linear-gradient(135deg, #1E3A8A 0%, #2563EB 100%);
      position: relative;
      border-radius: 16px 16px 0 0;
      overflow: hidden;
      box-shadow: 0 4px 20px rgba(30, 58, 138, 0.2);
    }

    .banner::before {
      content: '';
      position: absolute;
      top: -50%;
      right: -20%;
      width: 500px;
      height: 500px;
      background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
      border-radius: 50%;
      animation: float 6s ease-in-out infinite;
    }

    .banner::after {
      content: '';
      position: absolute;
      bottom: -40%;
      left: -10%;
      width: 400px;
      height: 400px;
      background: radial-gradient(circle, rgba(255,255,255,0.08) 0%, transparent 70%);
      border-radius: 50%;
      animation: float 8s ease-in-out infinite reverse;
    }

    @keyframes float {
      0%, 100% { transform: translateY(0) translateX(0); }
      50% { transform: translateY(-15px) translateX(15px); }
    }

    /* ===== Logout Button ===== */
    .logout-btn {
      position: absolute;
      top: 1.5rem;
      right: 1.5rem;
      background: linear-gradient(135deg, #DC2626 0%, #B91C1C 100%);
      padding: 0.8rem 1.5rem;
      border-radius: 10px;
      color: #fff;
      cursor: pointer;
      font-size: 0.95rem;
      font-weight: 600;
      border: none;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(220, 38, 38, 0.3);
      z-index: 10;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .logout-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(220, 38, 38, 0.4);
    }

    /* ===== Profile Card ===== */
    .profile-card {
      background: #FFFFFF;
      border-radius: 16px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
      margin-top: -80px;
      position: relative;
      z-index: 5;
    }

    /* ===== Profile Header ===== */
    .profile-header {
      display: flex;
      align-items: flex-start;
      gap: 2rem;
      padding: 2rem 2.5rem;
      border-bottom: 1px solid #F3F4F6;
    }

    .profile-pic-wrapper {
      position: relative;
    }

    .profile-pic {
      width: 160px;
      height: 160px;
      border-radius: 50%;
      border: 6px solid #FFFFFF;
      background: linear-gradient(135deg, #E5E7EB 0%, #D1D5DB 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 3.5rem;
      font-weight: 700;
      color: #6B7280;
      overflow: hidden;
      flex-shrink: 0;
      box-shadow: 0 8px 24px rgba(0,0,0,0.15);
      transition: transform 0.3s ease;
    }

    .profile-pic:hover {
      transform: scale(1.05);
    }

    .profile-pic img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .profile-info {
      flex: 1;
      padding-top: 1rem;
    }

    .profile-info h2 {
      font-size: 2.2rem;
      color: #1E3A8A;
      font-weight: 700;
      margin-bottom: 0.5rem;
    }

    .profile-info .bio {
      font-size: 1.05rem;
      color: #6B7280;
      line-height: 1.6;
      margin-bottom: 1.5rem;
    }

    /* ===== Stats Section ===== */
    .stats {
      display: flex;
      gap: 3rem;
      margin-top: 1rem;
    }

    .stat-item {
      cursor: pointer;
      transition: transform 0.3s ease;
      padding: 0.75rem 1.5rem;
      border-radius: 10px;
      background: #F3F4F6;
    }

    .stat-item:hover {
      transform: translateY(-3px);
      background: linear-gradient(135deg, #2563EB 0%, #1E3A8A 100%);
    }

    .stat-item:hover strong,
    .stat-item:hover span {
      color: #FFFFFF;
    }

    .stat-item strong {
      display: block;
      font-size: 1.8rem;
      color: #2563EB;
      font-weight: 700;
      transition: color 0.3s ease;
    }

    .stat-item span {
      font-size: 0.9rem;
      color: #6B7280;
      font-weight: 500;
      transition: color 0.3s ease;
    }

    /* ===== Details Section ===== */
    .details-section {
      padding: 2.5rem;
    }

    .details-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .detail-item {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 1rem 1.5rem;
      background: #F3F4F6;
      border-radius: 12px;
      transition: all 0.3s ease;
    }

    .detail-item:hover {
      background: #E5E7EB;
      transform: translateX(5px);
    }

    .detail-icon {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, #2563EB 0%, #1E3A8A 100%);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #FFFFFF;
      font-size: 1.1rem;
      flex-shrink: 0;
    }

    .detail-content {
      flex: 1;
    }

    .detail-label {
      font-size: 0.85rem;
      color: #6B7280;
      font-weight: 500;
      margin-bottom: 0.25rem;
    }

    .detail-value {
      font-size: 1rem;
      color: #111827;
      font-weight: 600;
    }

    .detail-value a {
      color: #2563EB;
      text-decoration: none;
      transition: color 0.3s ease;
    }

    .detail-value a:hover {
      color: #1E3A8A;
      text-decoration: underline;
    }

    /* ===== Action Buttons ===== */
    .action-buttons {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .btn {
      background: linear-gradient(135deg, #2563EB 0%, #1E3A8A 100%);
      color: #FFFFFF;
      border: none;
      padding: 1rem 2rem;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      font-size: 1rem;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(37, 99, 235, 0.3);
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(37, 99, 235, 0.4);
    }

    .btn i {
      font-size: 1.1rem;
    }

    /* ===== Modal ===== */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.6);
      justify-content: center;
      align-items: center;
      backdrop-filter: blur(4px);
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .modal-content {
      background: #FFFFFF;
      padding: 2.5rem;
      border-radius: 16px;
      width: 500px;
      max-width: 90%;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
      animation: slideUp 0.3s ease;
    }

    @keyframes slideUp {
      from { transform: translateY(50px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    .modal-content h3 {
      margin-top: 0;
      margin-bottom: 1.5rem;
      font-size: 1.8rem;
      color: #1E3A8A;
      font-weight: 700;
    }

    .club-list {
      list-style: none;
      padding: 0;
      margin: 0 0 1.5rem 0;
    }

    .club-list li {
      padding: 1rem;
      border-bottom: 1px solid #F3F4F6;
      color: #374151;
      font-size: 1rem;
      transition: background 0.3s ease;
    }

    .club-list li:hover {
      background: #F3F4F6;
      padding-left: 1.5rem;
    }

    .club-list li:last-child {
      border-bottom: none;
    }

    .modal-content input,
    .modal-content textarea {
      width: 100%;
      padding: 0.9rem;
      margin-bottom: 1rem;
      border-radius: 10px;
      border: 2px solid #E5E7EB;
      font-size: 0.95rem;
      transition: border-color 0.3s ease;
      font-family: inherit;
    }

    .modal-content input:focus,
    .modal-content textarea:focus {
      outline: none;
      border-color: #2563EB;
    }

    .modal-content textarea {
      resize: vertical;
      min-height: 100px;
    }

    .file-btn {
      display: inline-block;
      padding: 0.8rem 1.5rem;
      background: linear-gradient(135deg, #6B7280 0%, #4B5563 100%);
      color: #FFFFFF;
      border-radius: 10px;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 600;
      transition: all 0.3s ease;
      margin-bottom: 1rem;
    }

    .file-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(107, 114, 128, 0.3);
    }

    .file-btn input {
      display: none;
    }

    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 1rem;
      margin-top: 1.5rem;
    }

    .modal-actions .btn {
      padding: 0.8rem 1.5rem;
    }

    .save-btn {
      background: linear-gradient(135deg, #10B981 0%, #059669 100%);
      box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
    }

    .save-btn:hover {
      box-shadow: 0 4px 16px rgba(16, 185, 129, 0.4);
    }

    .cancel-btn {
      background: linear-gradient(135deg, #DC2626 0%, #B91C1C 100%);
      box-shadow: 0 2px 8px rgba(220, 38, 38, 0.3);
    }

    .cancel-btn:hover {
      box-shadow: 0 4px 16px rgba(220, 38, 38, 0.4);
    }

    /* ===== Responsive ===== */
    @media (max-width: 768px) {
      .navbar {
        gap: 1rem;
        padding: 1rem;
      }

      .navbar a {
        padding: 0.5rem 0.75rem;
        font-size: 0.8rem;
      }

      .navbar i {
        font-size: 1.2rem;
      }

      .profile-header {
        flex-direction: column;
        align-items: center;
        text-align: center;
        padding: 1.5rem;
      }

      .profile-pic {
        width: 120px;
        height: 120px;
        font-size: 2.5rem;
      }

      .profile-info h2 {
        font-size: 1.8rem;
      }

      .stats {
        flex-direction: column;
        gap: 1rem;
      }

      .stat-item {
        text-align: center;
      }

      .details-section {
        padding: 1.5rem;
      }

      .details-grid {
        grid-template-columns: 1fr;
      }

      .logout-btn {
        top: 1rem;
        right: 1rem;
        padding: 0.6rem 1rem;
        font-size: 0.85rem;
      }
    }
  </style>
</head>
<body>
  <div id="toast-container"></div>
  <!-- ===== Navbar ===== -->
  <div class="navbar">
    <a href="/student/<%= user.id %>/home">
      <i class="fas fa-home"></i>
      <span>Home</span>
    </a>
    <a href="/student/<%= user.id %>/clubs">
      <i class="fas fa-layer-group"></i>
      <span>Clubs</span>
    </a>
    <a href="/student/<%= user.id %>/messages">
      <i class="fas fa-comments"></i>
      <span>Messages</span>
    </a>
    <a href="/student/<%= user.id %>">
      <i class="fas fa-user"></i>
      <span>Profile</span>
    </a>
  </div>

  <!-- ===== Profile Container ===== -->
  <div class="profile-container">
    <!-- Banner -->
    <div class="banner">
      <button class="logout-btn" onclick="window.location='/logout'">
        <i class="fas fa-sign-out-alt"></i>
        Log Out
      </button>
    </div>

    <!-- Profile Card -->
    <div class="profile-card">
      <!-- Profile Header -->
      <div class="profile-header">
        <div class="profile-pic-wrapper">
          <div class="profile-pic">
            <% if (user.profile_data && user.profile_data.profilePic) { %>
              <img src="<%= user.profile_data.profilePic %>" alt="Profile Picture">
            <% } else { %>
              <span><%= user.username.charAt(0).toUpperCase() %></span>
            <% } %>
          </div>
        </div>

        <div class="profile-info">
          <h2><%= (user.profile_data && user.profile_data.fullName) || user.username %></h2>
          <p class="bio"><%= (user.profile_data && user.profile_data.bio) || "No bio yet. Share something about yourself!" %></p>

          <!-- Stats -->
          <div class="stats">
            <div class="stat-item" onclick="openClubModal('subscribed')">
              <strong>5</strong>
              <span>Subscribed Clubs</span>
            </div>
            <div class="stat-item" onclick="openClubModal('joined')">
              <strong>3</strong>
              <span>Joined Clubs</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Details Section -->
      <div class="details-section">
        <div class="details-grid">
          <div class="detail-item">
            <div class="detail-icon">
              <i class="fas fa-envelope"></i>
            </div>
            <div class="detail-content">
              <div class="detail-label">Email Address</div>
              <div class="detail-value"><%= user.email %></div>
            </div>
          </div>

          <% if (user.profile_data && user.profile_data.phone) { %>
          <div class="detail-item">
            <div class="detail-icon">
              <i class="fas fa-phone"></i>
            </div>
            <div class="detail-content">
              <div class="detail-label">Phone Number</div>
              <div class="detail-value"><%= user.profile_data.phone %></div>
            </div>
          </div>
          <% } %>

          <% if (user.profile_data && user.profile_data.linkedin) { %>
          <div class="detail-item">
            <div class="detail-icon">
              <i class="fab fa-linkedin"></i>
            </div>
            <div class="detail-content">
              <div class="detail-label">LinkedIn Profile</div>
              <div class="detail-value">
                <a href="<%= user.profile_data.linkedin %>" target="_blank">View Profile</a>
              </div>
            </div>
          </div>
          <% } %>

          <% if (user.profile_data && user.profile_data.cv) { %>
          <div class="detail-item">
            <div class="detail-icon">
              <i class="fas fa-file-alt"></i>
            </div>
            <div class="detail-content">
              <div class="detail-label">Curriculum Vitae</div>
              <div class="detail-value">
                <a href="<%= user.profile_data.cv %>" target="_blank">Download CV</a>
              </div>
            </div>
          </div>
          <% } %>
        </div>

        <div class="action-buttons">
          <button class="btn message-btn" onclick="openMessagesModal()">
            <i class="fas fa-comments"></i>
            Messages
          </button>
          <button class="btn" onclick="openEditModal()">
            <i class="fas fa-edit"></i>
            Edit Profile
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== Messages Modal ===== -->
  <div class="modal" id="messagesModal">
    <div class="modal-content" style="width: 90%; max-width: 1200px; height: 80vh;">
      <h3><i class="fas fa-comments"></i> Messages</h3>
      <div style="display: flex; gap: 2rem; height: calc(80vh - 150px);">
        <!-- Messages List -->
        <div style="flex: 1; background: #F9FAFB; border-radius: 12px; padding: 1rem; overflow-y: auto;">
          <h4 style="color: #1E3A8A; margin-bottom: 1rem; font-size: 1.2rem;">Club Chats</h4>
          <div id="club-chats-list" style="display: flex; flex-direction: column; gap: 0.5rem;">
            <!-- Club chats will be loaded here -->
          </div>
        </div>
        <!-- Chat Interface -->
        <div id="chat-interface" style="flex: 2; background: #FFFFFF; border-radius: 12px; padding: 1rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1); display: flex; flex-direction: column;">
          <div style="flex: 1; overflow-y: auto; background: #F9FAFB; border-radius: 8px; margin-bottom: 1rem; padding: 1rem;">
            <div style="text-align: center; color: #6B7280; padding: 2rem;">Select a club chat to start messaging</div>
          </div>
        </div>
      </div>
      <div class="modal-actions">
        <button type="button" class="btn cancel-btn" onclick="closeMessagesModal()">
          <i class="fas fa-times"></i> Close
        </button>
      </div>
    </div>
  </div>

  <!-- ===== Edit Profile Modal ===== -->
  <div class="modal" id="editModal">
    <div class="modal-content">
      <h3>Edit Your Profile</h3>
      <form action="/updateProfile" method="POST" enctype="multipart/form-data">
        <input type="hidden" name="redirect" value="profile">
        <input type="text" name="fullName" placeholder="Full Name" value="<%= user.profile_data ? user.profile_data.fullName : '' %>">
        <textarea name="bio" placeholder="Tell us about yourself..."><%= user.profile_data ? user.profile_data.bio : '' %></textarea>
        <input type="text" name="phone" placeholder="Phone Number" value="<%= user.profile_data ? user.profile_data.phone : '' %>">
        <input type="text" name="linkedin" placeholder="LinkedIn URL" value="<%= user.profile_data ? user.profile_data.linkedin : '' %>">
        <label class="file-btn">
          <i class="fas fa-image"></i> Upload Profile Picture
          <input type="file" name="profilePic" accept="image/*">
        </label>
        <br>
        <label class="file-btn">
          <i class="fas fa-file-upload"></i> Upload CV (PDF, DOC)
          <input type="file" name="cv" accept=".pdf,.doc,.docx">
        </label>
        <div class="modal-actions">
          <button type="submit" class="btn save-btn">
            <i class="fas fa-save"></i> Save Changes
          </button>
          <button type="button" class="btn cancel-btn" onclick="closeEditModal()">
            <i class="fas fa-times"></i> Cancel
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- ===== Clubs Modal ===== -->
  <div class="modal" id="clubsModal">
    <div class="modal-content">
      <h3 id="clubsTitle">Clubs</h3>
      <ul class="club-list" id="clubsList">
        <!-- Filled dynamically -->
      </ul>
      <div class="modal-actions">
        <button type="button" class="btn cancel-btn" onclick="closeClubsModal()">
          <i class="fas fa-times"></i> Close
        </button>
      </div>
    </div>
  </div>

  <script>
    const editModal = document.getElementById('editModal');
    function openEditModal() { editModal.style.display = 'flex'; }
    function closeEditModal() { editModal.style.display = 'none'; }

    const messagesModal = document.getElementById('messagesModal');
    function openMessagesModal() { messagesModal.style.display = 'flex'; initStudentChat(); }
    function closeMessagesModal() { messagesModal.style.display = 'none'; }

    const clubsModal = document.getElementById('clubsModal');
    const clubsList = document.getElementById('clubsList');
    const clubsTitle = document.getElementById('clubsTitle');

    function openClubModal(type) {
      clubsModal.style.display = 'flex';
      clubsList.innerHTML = '';
      if (type === 'subscribed') {
        clubsTitle.textContent = 'Subscribed Clubs';
        clubsList.innerHTML = '<li>AI Club</li><li>Sports Club</li><li>Music Club</li><li>Photography Club</li><li>Debate Society</li>';
      } else {
        clubsTitle.textContent = 'Joined Clubs';
        clubsList.innerHTML = '<li>Coding Club</li><li>Debate Club</li><li>Art Club</li>';
      }
    }
    function closeClubsModal() { clubsModal.style.display = 'none'; }

    window.onclick = function(event) {
      if (event.target === editModal) closeEditModal();
      if (event.target === messagesModal) closeMessagesModal();
      if (event.target === clubsModal) closeClubsModal();
    }

    // Student Chat Functionality
    const socket = io();
    const studentId = <%= user.id %>;
    let currentClubChat = null;

    function initStudentChat() {
      // Join rooms for the student user
      socket.emit('join-rooms', { userId: studentId, role: 'student' });
      loadSubscribedClubs();
    }

    async function loadSubscribedClubs() {
      try {
        const response = await fetch('/api/subscriptions/' + studentId);
        const subscriptions = await response.json();

        const clubChatsList = document.getElementById('club-chats-list');
        clubChatsList.innerHTML = '';

        if (subscriptions.length === 0) {
          clubChatsList.innerHTML = '<div style="color: #6B7280; text-align: center;">No subscribed clubs</div>';
          return;
        }

        subscriptions.forEach(function(sub) {
          const club = sub.club; // Assuming subscription includes club data
          const div = document.createElement('div');
          div.style.cssText = 'padding: 1rem; border-radius: 8px; background: #FFFFFF; margin-bottom: 0.5rem; cursor: pointer; border: 2px solid #E5E7EB; transition: all 0.3s ease;';
          div.onclick = function() { openClubChat(club.id, club.username); };
          div.innerHTML = '<div style="font-weight: 600; color: #2563EB;">' + club.username + '</div>' +
                          '<div style="color: #6B7280; font-size: 0.9rem;">Click to chat</div>';
          clubChatsList.appendChild(div);
        });
      } catch (err) {
        console.error('Error loading subscriptions:', err);
      }
    }

    function openClubChat(clubId, clubName) {
      currentClubChat = clubId;
      const chatInterface = document.getElementById('chat-interface');
      chatInterface.innerHTML = '<div style="flex: 1; overflow-y: auto; background: #F9FAFB; border-radius: 8px; margin-bottom: 1rem; padding: 1rem; min-height: 300px;"><div style="text-align: center; color: #6B7280; padding: 2rem;">Chatting with ' + clubName + '</div></div><div style="display: flex; gap: 0.5rem;"><input type="text" id="student-message-input" placeholder="Type your message..." style="flex: 1; padding: 0.75rem; border: 2px solid #E5E7EB; border-radius: 8px; font-size: 0.95rem;"><button id="student-send-button" class="btn" style="padding: 0.75rem 1.5rem;"><i class="fas fa-paper-plane"></i></button></div>';

      loadClubMessages(clubId);

      // Bind send functionality
      document.getElementById('student-send-button').addEventListener('click', function() { sendClubMessage(clubId); });
      document.getElementById('student-message-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') sendClubMessage(clubId);
      });
    }

    async function loadClubMessages(clubId) {
      try {
        const response = await fetch('/messages/student/' + studentId);
        const messages = await response.json();

        // Filter messages for current club
        const clubMessages = messages.filter(function(msg) {
          return msg.senderId === clubId || msg.receiverId === studentId || msg.clubId === clubId;
        });

        const chatMessages = document.querySelector('#chat-interface > div');
        const messagesArea = chatMessages.querySelector('div');
        messagesArea.innerHTML = '';

        if (clubMessages.length === 0) {
          messagesArea.innerHTML = '<div style="text-align: center; color: #6B7280; padding: 2rem;">No messages yet. Start chatting!</div>';
          return;
        }

        clubMessages.forEach(function(msg) {
          const messageDiv = document.createElement('div');
          const isSent = msg.senderId === studentId;
          messageDiv.style.cssText = 'margin-bottom: 1rem; padding: 0.75rem; border-radius: 8px; max-width: 70%; ' +
                                    (isSent ? 'margin-left: auto; background: #2563EB; color: #FFFFFF;' : 'background: #FFFFFF; color: #111827;');
          messageDiv.innerHTML = '<div style="font-weight: 600; margin-bottom: 0.25rem;">' + msg.senderName + '</div>' +
                                '<div>' + msg.message + '</div>' +
                                '<div style="font-size: 0.8rem; opacity: 0.8;">' + new Date(msg.timestamp).toLocaleString() + '</div>';
          messagesArea.appendChild(messageDiv);
        });

        messagesArea.scrollTop = messagesArea.scrollHeight;
      } catch (err) {
        console.error('Error loading messages:', err);
      }
    }

    function sendClubMessage(clubId) {
      const input = document.getElementById('student-message-input');
      const message = input.value.trim();

      if (!message) return;

      socket.emit('send-message', {
        senderId: studentId,
        receiverId: null,
        clubId: clubId,
        message: message
      });

      input.value = '';
    }

    // Socket.IO message event listeners
    socket.on('new-message', function(msg) {
      if (currentClubChat) {
        loadClubMessages(currentClubChat);
      }
    });

    socket.on('error', function(data) {
      showToast(data.message, 'error');
    });
  </script>
  <style>
    #toast-container { z-index:9999; position:fixed; top:32px; left:50%; transform:translateX(-50%); display:flex; flex-direction:column; align-items:center; }
    .toast { opacity:0; min-width:250px; margin-top:12px; padding: 1em 2em; border-radius: 8px; background: #2563eb; color: #fff; box-shadow:0 4px 16px rgba(0,0,0,0.12); font-weight:500; transition:opacity 0.4s, transform 0.4s; transform:translateY(-25px) scale(0.95); transition:all 0.4s; pointer-events:none; }
    .toast.show { opacity: 1; transform:translateY(0) scale(1); }
    .toast-error { background:#e11d48; }
    .toast-success { background:#16a34a; }
  </style>
</body>
</html>
